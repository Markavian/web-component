<!DOCTYPE html>
<html>

<head>
  <title>Web Component Examples - Monitor Status Debug</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.js"></script>
  <script src="../lib/web-component.js"></script>

  <!-- All the boostrap theming -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

  <!-- Code highlighting support -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/darkula.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>

  <style for="page">
    body {
      padding: 20px;
      font-family: sans-serif;
    }
  </style>

</head>

<body>
  <h1>Create a Web Component</h1>
  <p>This form helps you create a standalone Java Script include you use to develop your own web components. Your web component is then in a form that can then be included from anywhere on the web.</p>
  <create-a-web-component></create-a-web-component>

  <!-- Define the web component that drives this page -->
  <template for="create-a-web-component" template-id="default">
    <div class="panel panel-default">
      <div class="panel-heading">Live Preview</div>
      <div class="panel-body">
        <div class="row">
          <div class="col-md-6">
            <live-preview-form></live-preview-form>
          </div>
          <div class="col-md-6">
            <live-preview-output>Content preview will appear here.</live-preview-output>
          </div>
        </div>
      </div>
    </div>
    <div class="panel panel-default">
      <div class="panel-heading">Compiler</div>
      <div class="panel-body">
        <div class="row">
          <div class="col-md-6">
            <label for="template-fragment-{{template-id}}">Template</label>
            <pre><code class="html" id="template-fragment-{{template-id}}"></code></pre>

            <label for="javascript-fragment-{{template-id}}">JavaScript</label>
            <pre><code class="js" id="javascript-fragment-{{template-id}}"></code></pre>

            <label for="stylesheet-fragment-{{template-id}}">Stylesheet</label>
            <pre><code class="css" id="stylesheet-fragment-{{template-id}}"></code></pre>
          </div>
          <div class="col-md-6">
            <label for="web-component-output-{{template-id}}">Web Component</label>
            <web-component-output id="web-component-output-{{template-id}}"></web-component-output>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script type="text/javascript" for="create-a-web-component">
    $(function() {
      var CreateAWebComponent = Component.configure("create-a-web-component");

      CreateAWebComponent.on("renderComplete", function(instance) {
        CreateAWebComponent.bindInputEvents(instance);
        CreateAWebComponent.on('livePreviewUpdated', CreateAWebComponent.displayFragments);
        CreateAWebComponent.on('livePreviewUpdated', CreateAWebComponent.compileAsJavaScript);
      });

      CreateAWebComponent.bindInputEvents = function(instance) {
        $('textarea', instance.element).bind('input propertychange', function() {
          CreateAWebComponent.updateLivePreview(instance);
        });
        $(instance.element).on('keydown', 'textarea', CreateAWebComponent.catchTab);
      };

      CreateAWebComponent.updateLivePreview = function(instance) {
        var source = $('textarea', instance.element).val();
        var preview = $('live-preview-output', instance.element);
        preview.html("");
        try {
          var parsed = document.createElement('div');
          parsed.innerHTML = source;

          var templates = $('template', parsed);
          var styles = $('style', parsed);
          var scripts = $('script', parsed);

          var display = document.createElement('div');
          display.innerHTML = source;
          $('template', display).remove();
          $('style', display).remove();
          $('script', display).remove();
          preview.append(display);

          templates.each(function(key, value) {
            var displayString = CreateAWebComponent.getHTML(value, true);
            preview.append(displayString);
          });

          styles.each(function(key, value) {
            displayString = CreateAWebComponent.getHTML(value, true);
            preview.append(displayString);
          });

          preview.each(function() {
            var scope = this;
            Component.registerTemplates(scope).scanForComponents(scope);
          });

          scripts.each(function(key, value) {
            var displayString = CreateAWebComponent.getHTML(value, true);
            preview.append(displayString);
          });

          instance.dispatchEvent('livePreviewUpdated');
        } catch (e) {
          preview.html(e.toString());
        }
      };

      CreateAWebComponent.catchTab = function(e) {
        if (e.keyCode == 9) {
          var myValue = "\t";
          var startPos = this.selectionStart;
          var endPos = this.selectionEnd;
          var scrollTop = this.scrollTop;
          this.value = this.value.substring(0, startPos) + myValue + this.value.substring(endPos, this.value.length);
          this.focus();
          this.selectionStart = startPos + myValue.length;
          this.selectionEnd = startPos + myValue.length;
          this.scrollTop = scrollTop;
          e.preventDefault();
        }
      };

      CreateAWebComponent.displayFragments = function(instance) {
        var templateBlock = $('code[class="html"]');
        var stylesheetBlock = $('code[class="css"]');
        var javascriptBlock = $('code[class="js"]');

        templateBlock.html("");
        stylesheetBlock.html("");
        javascriptBlock.html("");

        var source = $('textarea', instance.element).val();
        var parsed = document.createElement('div');
        parsed.innerHTML = source;

        var templates = $('template', parsed);
        var styles = $('style', parsed);
        var scripts = $('script', parsed);

        templates.each(function(key, value) {
          var displayString = CreateAWebComponent.getHTML(value, true);
          displayString = hljs.highlight("html", displayString, true).value;
          templateBlock.html(displayString);
        });

        scripts.each(function(key, value) {
          var displayString = CreateAWebComponent.getHTML(value, true);
          displayString = hljs.highlight("html", displayString, true).value;
          javascriptBlock.html(displayString);
        });

        styles.each(function(key, value) {
          var displayString = CreateAWebComponent.getHTML(value, true);
          displayString = hljs.highlight("html", displayString, true).value;
          stylesheetBlock.html(displayString);
        });
      };

      CreateAWebComponent.encodeHtmlForJavaScript = function(html) {
        return encodeURIComponent(html);
      }

      CreateAWebComponent.encodeHtmlAsJavaScriptString = function(html) {
        var NL = "\n";
        var lines = html.split(NL);
        var result = "";
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i];
          result += '"' + CreateAWebComponent.encodeHtmlForJavaScript(line) + '"';
          if (i < lines.length - 1) {
            result += " + " + NL;
          }
        }
        result = result.replace(/%20%20/g, '');
        return result;
      }

      CreateAWebComponent.compileAsJavaScript = function(instance) {
        var outputBlock = $('web-component-output');

        var source = $('textarea', instance.element).val();
        var parsed = document.createElement('div');
        parsed.innerHTML = source;

        var templates = $('template', parsed);
        var styles = $('style', parsed);
        var scripts = $('script', parsed);

        var result = '';
        var NL = "\n";

        result += "// Templates " + NL;
        var templateData = [];
        templates.each(function(key, value) {
          var fragmentString = CreateAWebComponent.getHTML(value, true);
          var fragment = CreateAWebComponent.encodeHtmlAsJavaScriptString(fragmentString) + NL;
          templateData.push(fragment);
        });
        result += "var encodedTemplateTags = [" + templateData.join(", ") + "];" + NL;

        result += "// Scripts " + NL;
        var scriptData = [];
        scripts.each(function(key, value) {
          var fragmentString = CreateAWebComponent.getHTML(value, true);
          var fragment = CreateAWebComponent.encodeHtmlAsJavaScriptString(fragmentString) + NL;
          scriptData.push(fragment);
        });
        result += "var encodedScriptTags = [" + scriptData.join(", ") + "];" + NL;

        result += "// Styles " + NL;
        var styleData = [];
        styles.each(function(key, value) {
          var fragmentString = CreateAWebComponent.getHTML(value, true);
          var fragment = CreateAWebComponent.encodeHtmlAsJavaScriptString(fragmentString) + NL;
          styleData.push(fragment);
        });
        result += "var encodedStyleTags = [" + styleData.join(", ") + "];" + NL;

        outputBlock.html("<pre>" + result + "</pre>");
      };

      CreateAWebComponent.replaceHtmlEntities = function(content) {
        return String(content).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      };

      CreateAWebComponent.getHTML = function(who, deep) {
        if (!who || !who.tagName) return '';
        var txt, ax, el = document.createElement("div");
        el.appendChild(who.cloneNode(false));
        txt = el.innerHTML;
        if (deep) {
          ax = txt.indexOf('>') + 1;
          txt = txt.substring(0, ax) + who.innerHTML + txt.substring(ax);
        }
        el = null;
        return txt;
      }

      CreateAWebComponent.apply(function(instance) {
        instance.render();
      });
    });
  </script>

  <template for="live-preview-form">
    <form>
      <div class="form-group">
        <textarea type="text" class="form-control" id="live-preview-form" placeholder="Type here: <my-component></my-component>" rows="12"></textarea>
      </div>
    </form>
  </template>

  <style for="live-preview-form">
    live-preview-form > form > div > textarea {
      font-family: monospace;
    }
  </style>

</body>

</html>
